<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="theme-color" content="#000000">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
		  integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: sans-serif;
		}

		.App {
			text-align: center;
		}

		.App-logo {
			height: 80px;
		}

		.App-header {
			background-color: #222;
			height: 150px;
			padding: 20px;
			color: white;
		}

		.App-title {
			font-size: 1.5em;
		}

		.App-intro {
			font-size: large;
		}

		table {
			text-align: left;
		}

		table td:nth-child(odd) {
			background-color: #abc;
		}

		table p {
			margin-bottom: 0.5rem;
		}

		.tableBackgroundWhite * {
			background-color: white !important;
		}

		.tableBackgroundCustom * {
			background-color: #abc !important;
		}

		.steamProfilePic {
			width: 5em;
			height: 5em;
		}

		.gamesPlayed td {
			padding: 0;
		}

		.noBorder {
			border: 0 !important;
		}
	</style>
</head>
<body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/hyperhtml@2.10.0/index.js"></script>

<div class="App">
	<header class="App-header">
		<img src="karhu.png" class="App-logo">
		<h1 class="App-title">TF2 Status</h1>
	</header>
	<br>
	<p class="App-intro">
		Copy the <code>status</code> console command output, from TF2, into the box below:
	</p>
	<div>
		<textarea id="input" placeholder="" rows="16" cols="80"></textarea>
		<br>
		<br>
		<input type="button" onclick="main()" onkeypress="enter" value="Check" class="btn btn-primary btn-lg ">
	</div>
	<br>
	<div id="container"></div>
</div>
<script>class BaseComponent extends hyperHTML.Component {
	constructor(props) {
		super()
		this.props = props
		this.label = props.label
		this.data = props.data || ''
	}

	render() {
		return this.html`<td>${this.data}</td>`
	}
}

class ETF2LProfileID extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		let content = ''
		if (this.props.player.ETF2LProfileID) {
			let url = `https://etf2l.org/forum/user/${this.props.player.ETF2LProfileID}`
			content = hyperHTML.wire()`<a href="${url}">ETF2L Profile</a>`
		}

		return this.html`<td>${content}</td>`
	}
}

class LogstfLink extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		let url = `https://logs.tf/search/player?s=${this.props.player.steamID}`
		return this.html`<td><a href="${url}">Logs.tf</a></td>`
	}
}

class SteamProfilePic extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		return this.html`<td><img src="${this.data}" class="steamProfilePic"></td>`
	}
}

class TextComponent extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		return this.html`<td>${this.data}</td>`
	}
}

class Teams extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		if (this.props.data && this.props.data.length > 0) {
			let teams = []
			for (let i of this.props.data) {
				teams.push(hyperHTML.wire()`<p>${i.type} : ${i.name}</p>`)
			}
			return this.html`<td>${teams}</td>`
		} else {
			return this.html`<td></td>`
		}
	}
}

class _Played extends BaseComponent {
	constructor(props) {
		super(props)

		this.container = []
	}

	addRows(compType, playedGames) {
		let games = {'6on6': {}, Highlander: {}, Rest: {}}
		let container = this.container

		for (let i of playedGames) {
			if (!games[compType][i.division]) games[compType][i.division] = 0

			games[compType][i.division] += 1
		}

		for (let division in games[compType]) {
			container.push(hyperHTML.wire()`
							<tr>
								<td>
									${division}
								</td>
								<td style="text-align: right; padding-left: 0.5rem;">
									${games[compType][division]}
								</td>
							</tr>`)
		}

		if (container[0]) {
			for (let i of container[0].children) {
				i.classList.add('noBorder')
			}
		}
	}
}

class GamesPlayed6on6 extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRows('6on6', this.props.player.played6on6)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundWhite" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}

class GamesPlayedHL extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRows('Highlander', this.props.player.playedHL)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundCustom" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}

class GamesPlayedRest extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRows('Rest', this.props.player.playedRest)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundWhite" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}

class ItemComponent extends hyperHTML.Component {
	constructor(label, data, player) {
		super()

		this.label = label
		this.data = data
		this.player = player

		this.props = {label: label, data: data, player: player}

		const l = app.labels

		let is = (thatLabel) => {
			if (this.label === thatLabel) {
				return true
			}
			return false
		}

		if (is(l.nameETF2L) || is(l.nameServer) || is(l.country)) {
			this.component = new TextComponent(this.props)
		} else if (is(l.steamProfilePic)) {
			this.component = new SteamProfilePic(this.props)
		} else if (is(l.logstfLink)) {
			this.component = new LogstfLink(this.props)
		} else if (is(l.ETF2LProfileID)) {
			this.component = new ETF2LProfileID(this.props)
		} else if (is(l.teams)) {
			this.component = new Teams(this.props)
		} else if (is(l.gamesPlayed6on6)) {
			this.component = new GamesPlayed6on6(this.props)
		} else if (is(l.gamesPlayedHL)) {
			this.component = new GamesPlayedHL(this.props)
		} else if (is(l.gamesPlayedRest)) {
			this.component = new GamesPlayedRest(this.props)
		} else {
			this.component = hyperHTML.wire()`<td><!-- ItemComponent no element found --></td>`
		}
	}

	render() {
		return this.component
	}
}
</script>
<script>let api_request_rate_ms = 200
let players = {}

let playerID = 0
let app = {
	labelOrder: ['steamProfilePic', 'nameServer', 'nameETF2L', 'country', 'ETF2LProfileID', 'logstfLink', 'teams', 'gamesPlayed6on6', 'gamesPlayedHL', 'gamesPlayedRest'],
	labels: {},
}

app.labelOrder.forEach(function(i) {
	app.labels[i] = i
})

function main() {
	players = {}
	playerID = 0
	let wait = api_request_rate_ms

	let logLines = document.querySelector('#input').value
	logLines = logLines.split(/\r\n|\n/)

	//[ , name, steamID]
	const re = /#\s*\d+\s"(.+)"\s*(\[U:1:\d+\])/ //bug missing " on long names

	for (let i of logLines) {
		if (i.match(re)) {
			let currentLine = i
			let result = re.exec(currentLine)

			let nameServer = result[1]
			let steamID = result[2]

			players[playerID] = {
				playerID: playerID,
				steamID: steamID,
				nameServer: nameServer,
				steamProfilePic: '',
				nameETF2L: '',
				country: '',
				ETF2LProfileID: '',
				logstfLink: '',
				teams: [],
				gamesPlayed6on6: '',
				gamesPlayedHL: '',
				gamesPlayedRes: '',
				played6on6: [],
				playedHL: [],
				playedRest: [],
			}

			playerID++
		}

		renderTable()
	}

	Object.values(players).forEach(function(i) {
		let id = i.steamID //this needs to be 'let' because scope

		setTimeout(() => {
			axios
				.get(`http://api.etf2l.org/player/${id}.json`)
				.then(function(response) {
					if (response.data.status && response.data.status.message === 'OK' && response.data.player) {
						let nameETF2L = response.data.player.name
						let country = response.data.player.country
						i.nameETF2L = nameETF2L
						i.country = country
						i.ETF2LProfileID = response.data.player.id
						i.steamProfilePic = response.data.player.steam.avatar
						//i.response = response.data
						i.teams = response.data.player.teams

						i.played6on6 = []
						i.playedHL = []
						i.playedRest = []

						getResults(id, 1, i)
						renderTable()
					}
				})
				.catch(function(error) {
					console.log(error)
				})
		}, (wait += api_request_rate_ms))
	})
}

function getResults(id, pageID, player) {
	let wait = api_request_rate_ms

	setTimeout(() => {
		axios
			.get(`http://api.etf2l.org/player/${id}/results/${pageID}.json?since=0&per_page=100`)
			.then(function(response) {
				if (response.data.status && response.data.status.message === 'OK' && response.data.results) {
					let results = response.data.results

					for (let i of results) {
						let type = i.competition.type //6on6, 1v1, HL
						let division = i.division.name || i.competition.category //season a powered by b, fun cup, group a

						if (type === '6on6') {
							player.played6on6.push({key: '6on6', type: type, division: division})
						} else if (type === 'Highlander') {
							player.playedHL.push({key: 'HL', type: type, division: division})
						} else {
							player.playedRest.push({key: 'Rest', type: type, division: division})
						}
					}

					renderTable()

					let page = response.data.page
					if (page.next_page_url) {
						pageID += 1
						getResults(id, pageID, player)
					}
				}
			})
			.catch(function(error) {
				console.log(error)
			})
	}, (wait += api_request_rate_ms))
}

let table

function renderTable() {
	if (!table) {
		let tableContainer = document.querySelector('#container')
		table = new Table()
		hyperHTML(tableContainer)`${table}`
	} else {
		table.render()
	}
}

class TableRow extends hyperHTML.Component {
	constructor(player) {
		super()
		this.player = player
		this.TDs = []

		this.labelOrder = app.labelOrder
	}

	render() {
		for (let label of this.labelOrder) {
			this.TDs.push(new ItemComponent(label, this.player[label], this.player))
		}

		return this.html`
			<tr>
				${this.TDs}
			</tr>
		`
	}
}

class Table extends hyperHTML.Component {
	constructor() {
		super()
		this.rows = []

		this.tableHead = hyperHTML.wire()`
		<tr>
			<td></td>
			<td>Nickname</td>
			<td>ETF2L</td>
			<td>Country</td>
			<td></td>
			<td></td>
			<td>Teams</td>
			<td>6on6 played</td>
			<td>HL played</td>
			<td>Rest played</td>
		</tr>`
	}

	render() {
		let data = players
		let rows = []
		let tableHead = this.tableHead

		Object.values(data).forEach(function(player) {
			rows.push(new TableRow(player))
		})

		return this.html`
		<div class="table-responsive">
			<table align="center" class="table">
				<thead>${tableHead}</thead>
				<tbody>${rows}</tbody>
			</table>
		</div>`
	}
}

function enter(event) {
	if (event.key === 'Enter') {
		main()
	}
}
</script>
</body>
</html>