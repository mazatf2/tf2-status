<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        .App {
            text-align: center;
        }

        .App-logo {
            height: 80px;
        }

        .App-header {
            background-color: #222;
            height: 150px;
            padding: 20px;
            color: white;
        }

        .App-title {
            font-size: 1.5em;
        }

        .App-intro {
            font-size: large;
        }

        table {
            text-align: left;
        }

        table td {
            padding: 0.5em;
        }

        table td:nth-child(odd) {
            background-color: #abc;
        }

        .steamProfilePic {
            width: 5em;
            height: 5em;
        }
        .gamesPlayed {
            background-color: white !important;
        }

    </style>
</head>
<body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/hyperhtml@2.10.0/index.js"></script>


<div class="App">
    <header class="App-header">
        <img src="karhu.png" class="App-logo">
        <h1 class="App-title">TF2 Status</h1>
    </header>
    <br>
    <p class="App-intro">
        Copy <code>status</code> TF2 console command output to below.
    </p>
    <div>
        <textarea id="input" placeholder="" rows="16" cols="80"></textarea>
        <br>
        <br>
        <input type="button" onclick="main()" onkeypress="enter" value="Check" class="btn btn-primary btn-lg ">
    </div>
    <br>
    <div id="container"></div>
</div>

<script>

	var api_request_rate_ms = 200
	var players = []

	function main() {
		players = []
		let wait = api_request_rate_ms

		let logLines = document.querySelector('#input').value
		logLines = logLines.split(/\r\n|\n/)

		for (let i of logLines) {
			if (i && i.charAt(0) === '#' && !i.match(/# userid name/)) {
				let currentLine = i
				let nameServer = currentLine.split('"')[1]
				let steamID = currentLine.split('[')[1]

				try {
					steamID = steamID.split(']')[0]
					players.push({
						steamID: `[${steamID}]`,
						nameServer: nameServer,
						logstfLink: undefined,
						steamProfilePic: undefined
					})
				} catch (e) {
					console.error(e)
				}

			}
			renderTable()
		}

		for (let i of players) {

			let id = i.steamID //this needs to be 'let' because scope

			setTimeout(() => {
				axios.get(`http://api.etf2l.org/player/${id}.json`)
					.then(function (response) {
						if (response.data.status && response.data.status.message === 'OK' && response.data.player) {
							let nameETF2L = response.data.player.name
							let country = response.data.player.country
							i.nameETF2L = nameETF2L
							i.country = country
							i.ETF2LProfileID = response.data.player.id
							i.steamProfilePic = response.data.player.steam.avatar
							//i.response = response.data
							i.teams = response.data.player.teams
							i.gamesPlayed = ''

							getResults(id, 1, i)
							renderTable()

						}
					})
					.catch(function (error) {
						console.log(error)
					})
			}, wait += api_request_rate_ms)
		}
	}

	function getResults(id, pageID, player) {

		let wait = api_request_rate_ms


		setTimeout(() => {

			axios.get(`http://api.etf2l.org/player/${id}/results/${pageID}.json?since=0&per_page=100`)
				.then(function (response) {
					if (response.data.status && response.data.status.message === 'OK' && response.data.results) {

						let results = response.data.results
						let gamesPlayed = player.gamesPlayed || {}

						for (let i of results) {
							let type = i.competition.type
							let division = i.division.name || i.competition.category
							gamesPlayed[type] = gamesPlayed[type] || {}

							if (!gamesPlayed[type][division])
								gamesPlayed[type][division] = 0

							gamesPlayed[type][division] = gamesPlayed[type][division] += 1
						}

						player.gamesPlayed = gamesPlayed

						renderTable()

                        let page = response.data.page
                        if(page.next_page_url){
							pageID += 1
	                        getResults(id, pageID, player)
                        }

					}
				})
				.catch(function (error) {
					console.log(error)
				})
		}, wait += api_request_rate_ms)
	}

	function renderTable() {
		let tableContainer = document.querySelector('#container')
		let table = getTable()
		hyperHTML.bind(tableContainer)`${table}`
	}

	function getTable() {
		return generateTable(players)
	}

	function generateTable(data) {

		let rows = []
		let tableHead = hyperHTML.wire()`
		<tr>
			<td></td>
			<td>Nickname</td>
			<td>ETF2L</td>
			<td>Country</td>
			<td></td>
			<td></td>
			<td>Teams</td>
			<td>Games played</td>
		</tr>`

		if (typeof data[0] === 'object' || 'array') {


			for (let row in data) {

				let colums = {}

				for (let item in data[row]) {
					let content = data[row][item]
					//console.info(row, ' : ',item)
					if (item === 'ETF2LProfileID') {
						let url = `https://etf2l.org/forum/user/${content}`

						colums.ETF2LProfileID = hyperHTML.wire()`<td>
						<a href="${url}">ETF2L Profile</a>
						</td>`

					} else if (item === 'steamProfilePic') {
						let url = `https://etf2l.org/forum/user/${content}`

						colums.steamProfilePic = hyperHTML.wire()`<td>
						<img src=${content} class="steamProfilePic">
						</td>`

					} else if (item === 'logstfLink') {
						let url = `https://logs.tf/search/player?s=${data[row]['steamID']}`

						colums.logstfLink = hyperHTML.wire()`<td>
						<a href="${url}">Logs.tf</a>
						</td>`

					} else if (item === 'teams') {

						if (content) {

							let teams = []
							for (let i of content) {
								teams.push(hyperHTML.wire()`<p>${i.type} : ${i.name}</p>`)
							}
							colums.teams = hyperHTML.wire()`<td>${teams}</td>`
						} else {
							colums.teams = hyperHTML.wire()`<td></td>`
						}
					} else if (item === 'gamesPlayed') {

						if (content) {

							let gRows = []

							for (let compType in content) {
								for (let matchName in content[compType]) {
									gRows.push(hyperHTML.wire()`
                                        <tr>
                                            <td class="gamesPlayed">
                                                ${compType} : ${matchName}
                                            </td>
                                            <td class="gamesPlayed">
                                                ${content[compType][matchName]}
                                            </td>
                                        </tr>
                                    `)
								}
							}

                            gRows.push(hyperHTML.wire()`<hr>`)

							colums.gamesPlayed = hyperHTML.wire()`<table><tbody>${gRows}</tbody></table>`
						}

					} else if (item === 'steamID') {

					} else {
						colums[item] = hyperHTML.wire()`<td>${content}</td>`
					}
				}

				/*
				Object.keys(players[0])
				(7)Â ["steamID", "nameServer", "logstfLink", "steamProfilePic", "nameETF2L", "country", "ETF2LProfileID"]
				*/
				let displayOrder = ['steamProfilePic', 'nameServer', 'nameETF2L', 'country', 'ETF2LProfileID', 'logstfLink', 'teams', 'gamesPlayed']
				let sorted = []

				for (let i of displayOrder) {
					let result = colums[i] || hyperHTML.wire()`<td></td>`
					sorted.push(result)
				}

				rows.push(hyperHTML.wire()`<tr>${sorted}</tr>`)
			}
		}

		return hyperHTML.wire()`
			<table align="center">
				<thead>${tableHead}</thead>
				<tbody>${rows}</tbody>
			</table>`
	}

	function enter(event) {
		if (event.key === 'Enter') {
			main()
		}
	}
</script>
</body>
</html>