<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="theme-color" content="#000000">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
		  integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: sans-serif;
		}

		.App {
			text-align: center;
		}

		.App-logo {
			height: 80px;
		}

		.App-header {
			background-color: #222;
			height: 150px;
			padding: 20px;
			color: white;
		}

		.App-title {
			font-size: 1.5em;
		}

		.App-intro {
			font-size: large;
		}

		table {
			text-align: left;
		}

		table td:nth-child(odd) {
			background-color: #abc;
		}

		table p {
			margin-bottom: 0.5rem;
		}

		.tableBackgroundWhite * {
			background-color: white !important;
		}

		.tableBackgroundCustom * {
			background-color: #abc !important;
		}

		.steamProfilePic {
			width: 5em;
			height: 5em;
		}

		.gamesPlayed td {
			padding: 0;
		}

		.noBorder {
			border: 0 !important;
		}
	</style>
</head>
<body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/hyperhtml@2.10.0/index.js"></script>
<script src="https://unpkg.com/hyperhtml-app@0.2.1/min.js"></script>

<div class="App">
	<header class="App-header">
		<img src="karhu.png" class="App-logo">
		<h1 class="App-title">TF2 Status</h1>
	</header>
	<br>

	<div id="container"></div>
</div>
<script>class BaseComponent extends hyperHTML.Component {
	constructor(props, data) {
		super()
		this.props = props
		this.data = data || props.data
	}

	render() {
		return this.html`<td>${this.data}</td>`
	}
}

class Links extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		let content = []
		if (this.props.ETF2LProfileID) {
			let url = `https://etf2l.org/forum/user/${this.props.ETF2LProfileID}`
			content.push(hyperHTML.wire()`<p><a href="${url}">ETF2L</a></p>`)
		} else {
			let steamID = this.props.steamID.replace('[', '').replace(']', '')
			let url = `http://etf2l.org/search/${steamID}`
			content.push(hyperHTML.wire()`<p><a href="${url}" style="text-decoration: line-through">ETF2L</a></p>`)
		}
		let ugcUrl = `https://www.ugcleague.com/playersearch.cfm?steamid=${this.props.steamID}&steamid32=&steamid64=&player_name=&submit=Find+Players&results=`
		content.push(hyperHTML.wire()`<p><a href="${ugcUrl}">UGC</a></p>`)

		let eseaUrl = `https://play.esea.net/index.php?s=search&query=${this.props.steamID}&source=users`
		content.push(hyperHTML.wire()`<p><a href="${eseaUrl}">ESEA</a></p>`)

		return this.html`<td>${content}</td>`
	}
}

class LogstfLink extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		let url = `https://logs.tf/search/player?s=${this.props.steamID}`
		return this.html`<td><a href="${url}">Logs.tf</a></td>`
	}
}

class SteamProfilePic extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		return this.html`<td><img src="${this.props.steamProfilePic}" class="steamProfilePic"></td>`
	}
}

class TextComponent extends BaseComponent {
	constructor(props, data) {
		super(props, data)
	}

	render() {
		return this.html`<td>${this.data}</td>`
	}
}

class Teams extends BaseComponent {
	constructor(props) {
		super(props)
	}

	render() {
		let result = ''
		if (this.props.teams && this.props.teams.length > 0) {
			let teams = []
			for (let i of this.props.teams) {
				teams.push(hyperHTML.wire()`<p>${i.type} : ${i.name}</p>`)
			}
			result = teams
		}
		return this.html`<td>${result}</td>`
	}
}

class _Played extends BaseComponent {
	constructor(props) {
		super(props)

		this.container = []
	}

	addRows6on6HL(compType, playedGames) {
		let games = {
			Premiership: [],
			'Division: 1': [],
			'Division: 2': [],
			High: [],
			Mid: [],
			'Low / Open': [],
			Cup: [],
			error: [],
		}

		function checkDiv(result) {
			//"division": {"tier": null, "name": null, "id": null}
			//obj.category, obj.type
			//Premiership Preseason Playoffs
			//NA Rules Cup - LOW

			//tier 0
			//obj.category, obj.type
			//Premiership, Premiership Group, Premiership Tier

			//tier 1
			//obj.name: Division 1, Division 1A, High, High A, High tier

			//tier 2
			//Division 2, Mid, High/Mid

			//tier 3
			//Division 3, Division 3A, Open, Low
			//Grey Group
			//Open Group A

			//tier 4
			//Division 4, Division 4A, Open

			//tier 5
			//Division 5, Division 5A

			//tier 6
			//Division 6, Division 6A

			let rName = result.division.name || result.competition.name
			let category = result.competition.category || ''

			if (category.match(/The Highlander Open/)) {
				games.Cup.push(result)
			} else if (rName.match(/Premiership/)) {
				games.Premiership.push(result)
			} else if (rName.match(/Division 1/)) {
				games['Division: 1'].push(result)
			} else if (rName.match(/Division 2/)) {
				games['Division: 2'].push(result)
			} else if (rName.match(/Division 3/) || rName.match(/Division 4/)) {
				games.Mid.push(result)
			} else if (rName.match(/Division 5/) || rName.match(/Division 6/)) {
				games['Low / Open'].push(result)
			} else if (rName.match(/High/)) {
				games.High.push(result)
			} else if (rName.match(/Mid/)) {
				games.Mid.push(result)
			} else if (rName.match(/Low/) || rName.match(/Open/)) {
				games['Low / Open'].push(result)
			} else if (category.match(/Cup/)) {
				games.Cup.push(result)
			} else {
				games.error.push(result)
			}
		}

		for (let result of playedGames) {
			checkDiv(result)
		}

		Object.entries(games).forEach((a) => {
			let [division, obj] = a

			if (obj.length > 0) {
				this.container.push(hyperHTML.wire()`
					<tr>
						<td>${division}</td>
						<td style="text-align: right; padding-left: 0.5rem;">
							${obj.length}
						</td>
					</tr>
				`)
			}
		})

		if (this.container[0]) {
			for (let i of this.container[0].children) {
				i.classList.add('noBorder')
			}
		}
	}

	addRowsRest(compType, playedGames) {
		let games = {
			'1on1': [],
			'2on2': [],
			Cup: [],
		}

		function checkDiv(result) {
			let rName = result.division.name || result.competition.name
			let category = result.competition.category || ''
			let type = result.competition.type || ''

			if (type === '1on1') {
				games['1on1'].push(result)
			} else if (type === '2on2') {
				games['2on2'].push(result)
			} else {
				games.Cup.push(result)
			}
		}

		for (let result of playedGames) {
			checkDiv(result)
		}

		Object.entries(games).forEach((a) => {
			let [gameType, obj] = a

			if (obj.length > 0) {
				this.container.push(hyperHTML.wire()`
					<tr>
						<td>${gameType}</td>
						<td style="text-align: right; padding-left: 0.5rem;">
							${obj.length}
						</td>
					</tr>
				`)
			}
		})

		if (this.container[0]) {
			for (let i of this.container[0].children) {
				i.classList.add('noBorder')
			}
		}
	}
}

class GamesPlayed6on6 extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRows6on6HL('6on6', this.props.played6on6)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundWhite" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}

class GamesPlayedHL extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRows6on6HL('Highlander', this.props.playedHL)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundCustom" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}

class GamesPlayedRest extends _Played {
	constructor(props) {
		super(props)
	}

	render() {
		this.addRowsRest('Rest', this.props.playedRest)

		return this.html`
			<td>
				<table class="gamesPlayed tableBackgroundWhite" style="width: 100%"><tbody>${this.container}</tbody></table>
			</td>
		`
	}
}
</script>
<script>let api_request_rate_ms = 200
let players = {}
let playerID = 0

class Player {
	constructor(params) {
		params = params || {}

		this.playerID = playerID
		this.steamID = params.steamID || {}
		this.nameServer = params.nameServer || {}
		this.steamProfilePic = ''
		this.nameETF2L = ''
		this.country = ''
		this.ETF2LProfileID = ''
		this.logstfLink = ''
		this.teams = []
		this.gamesPlayed6on6 = ''
		this.gamesPlayedHL = ''
		this.gamesPlayedRes = ''
		this.played6on6 = []
		this.playedHL = []
		this.playedRest = []
		this.results = []

		players[this.playerID] = this
		playerID++
	}
}

//[ , name, steamID]
const statusRE = /#\s*\d+\s"(.+)"\s*(\[U:1:\d+\])/
const steamIDRE = /U:1:\d+/

function main(logLines) {
	players = {}
	playerID = 0
	let wait = api_request_rate_ms

	logLines = logLines || ''
	logLines = logLines.split(/\r\n|\n/)

	for (let i of logLines) {
		if (i.match(statusRE)) {
			let currentLine = i
			let result = statusRE.exec(currentLine)

			let nameServer = result[1]
			let steamID = result[2]

			let player = new Player({nameServer: nameServer, steamID: steamID})
		}

		renderTable()
	}

	Object.values(players).forEach(function(i) {
		let id = i.steamID //this needs to be 'let' because scope

		setTimeout(() => {
			axios
				.get(`http://api.etf2l.org/player/${id}.json`)
				.then(function(response) {
					if (response.data.status && response.data.status.message === 'OK' && response.data.player) {
						let nameETF2L = response.data.player.name
						let country = response.data.player.country
						i.nameETF2L = nameETF2L
						i.country = country
						i.ETF2LProfileID = response.data.player.id
						i.steamProfilePic = response.data.player.steam.avatar
						//i.response = response.data
						i.teams = response.data.player.teams

						i.played6on6 = []
						i.playedHL = []
						i.playedRest = []

						getResults(id, 1, i)
						renderTable()
					}
				})
				.catch(function(error) {
					console.log(error)
				})
		}, (wait += api_request_rate_ms))
	})
}

function getResults(id, pageID, player) {
	let wait = api_request_rate_ms

	setTimeout(() => {
		axios
			.get(`http://api.etf2l.org/player/${id}/results/${pageID}.json?since=0&per_page=100`)
			.then(function(response) {
				if (response.data.status && response.data.status.message === 'OK' && response.data.results) {
					let results = response.data.results
					player.results = player.results.concat(results)

					for (let i of results) {
						let type = i.competition.type //6on6, 1v1, HL

						if (type === '6on6') {
							player.played6on6.push(i)
						} else if (type === 'Highlander') {
							player.playedHL.push(i)
						} else {
							player.playedRest.push(i)
						}
					}

					renderTable()

					let page = response.data.page
					if (page.next_page_url) {
						pageID += 1
						getResults(id, pageID, player)
					}
				}
			})
			.catch(function(error) {
				console.log(error)
			})
	}, (wait += api_request_rate_ms))
}

function renderTable() {
	if (!table) {
		table = new Table()
		hyperHTML(tableContainer)`${table}`
	} else {
		table.render()
	}
}

class TextArea extends hyperHTML.Component {
	constructor(props) {
		super(props)
		this.props = props || {}
		this.props.value = this.props.value || ''

		this.init()
	}
	init() {
		let hash = window.location.hash || ''
		if (hash && hash.length > 1) {
			hash = hash.substring(1, hash.length) //del #
			let tuples = hash.split(',', 32 * 3)

			if (tuples[tuples.length] === ',') {
				tuples.splice(tuples.length - 1, 1)
			}
			for (let i = 0; i < tuples.length; i += 2) {
				let steamID = tuples[i + 1]
				if (steamID && steamID.match(steamIDRE)) {
					let name = decodeURI(tuples[i]).substr(0, 32)
					name = `"${name}"`.padEnd(32, ' ')
					let result = `#  0 ${name} [${steamID}]`

					this.props.value += '\r\n' + `#  0 ${name} [${steamID}]`
				}
			}
		}
	}

	onclick() {
		main(this.props.value)
	}

	oninput() {
		this.props.value = document.querySelector('#input').value

		let lines = this.props.value.split(/\r\n|\n/)

		let newHash = ''
		lines.forEach((i) => {
			if (i.match(statusRE)) {
				let result = statusRE.exec(i)

				let nameServer = result[1]
				let steamID = result[2].replace(/[\[|\]]/g, '')
				newHash += `${nameServer},${steamID},`
			}
		})

		if (newHash[newHash.length - 1] === ',') {
			newHash = newHash.slice(0, -1)
		}
		window.location.hash = newHash
	}
	render() {
		return this.html`
			<textarea id="input" placeholder="" rows="16" cols="80" oninput=${this}>${this.props.value}</textarea>
			<br>
			<br>
			<input type="button" onclick=${this} value="Check" class="btn btn-primary btn-lg ">
		`
	}
}

class Table extends hyperHTML.Component {
	constructor() {
		super()

		this.textArea = new TextArea()
		this.rows = []

		//['steamProfilePic', 'nameServer', 'nameETF2L', 'country', 'links', 'logstfLink', 'teams', 'gamesPlayed6on6', 'gamesPlayedHL', 'gamesPlayedRest']
		this.tableHead = hyperHTML.wire()`
		<tr>
			<td></td>
			<td>Nickname</td>
			<td>ETF2L</td>
			<td>Country</td>
			<td></td>
			<td></td>
			<td>Teams</td>
			<td>6on6 played</td>
			<td>HL played</td>
			<td>Rest played</td>
		</tr>`
	}

	render() {
		let data = players
		let rows = []
		let tableHead = this.tableHead

		let playerList = Object.values(data).filter(function() {
			return true
		})

		return this.html`
			<p class="App-intro">
			Copy the <code>status</code> console command output, from TF2, into the box below:
			</p>
			<div>
				${this.textArea}
			</div>
			<br>
			<div class="table-responsive">
				<table align="center" class="table">
					<thead>${tableHead}</thead>
					<tbody>
						${playerList.map(
							(player) => hyperHTML.wire(player)`
								<tr>
									${new SteamProfilePic(player)}
									${new TextComponent(player, player.nameServer)}
									${new TextComponent(player, player.nameETF2L)}
									${new TextComponent(player, player.country)}
									${new Links(player)}
									${new LogstfLink(player)}
									${new Teams(player)}
									${new GamesPlayed6on6(player)}
									${new GamesPlayedHL(player)}
									${new GamesPlayedRest(player)}
								</tr>
						`,
						)}
					</tbody>
				</table>
			</div>`
	}
}

let table
class FrontPage extends hyperHTML.Component {
	constructor() {
		super()
		this.table = new Table()
		table = this.table
	}
	render() {
		return this.html`${this.table}`
	}
}

const hyper = hyperHTML //needed for hyperHTML app router
const router = hyperHTML.app()
let frontPage = new FrontPage()

let path = window.location.pathname
let tableContainer = document.querySelector('#container')

router.get(path, (a) => {
	hyperHTML(tableContainer)`${frontPage}`
})

router.navigate(path)
</script>
</body>
</html>